{"version":3,"sources":["../src/index.ts"],"sourcesContent":["// ============================================================================\n// SIMPLIFIED DATABASE PACKAGE EXPORTS - NEW VERSION\n// ============================================================================\n// This is the new, simplified version that replaces the complex dual ID system\n// Goal: Reduce from 139 exports to ~10 simple functions\n\nimport { prisma } from './client';\nimport { simplifiedUsers } from './user';\nimport { simplifiedCustomers } from './customer';\nimport { simplifiedProducts } from './product';\nimport { simplifiedOrders } from './order';\nimport { simplifiedPayments } from './payment';\nimport { simplifiedOutlets } from './outlet';\nimport { simplifiedPlans } from './plan';\nimport { simplifiedSubscriptions } from './subscription';\nimport { simplifiedSubscriptionActivities } from './subscription-activity';\n// import { simplifiedMerchants } from './merchant'; // TEMPORARY: Disabled for multi-tenant migration\nimport { simplifiedOrderNumbers } from './order-number-generator';\nimport { simplifiedCategories } from './category';\nimport { simplifiedAuditLogs } from './audit-logs';\nimport { simplifiedOrderItems } from './order-items';\nimport { sessions } from './sessions';\n\n// Optimized order functions (temporarily disabled due to type issues)\n// export { \n//   searchOrdersOptimized, \n//   searchOrdersWithCursor, \n//   getOrderDetailsOptimized, \n//   getOrderSummary \n// } from './order-optimized';\n\n// Database client\nexport { prisma };\n\n// ============================================================================\n// TYPES FOR SIMPLIFIED API\n// ============================================================================\n\nexport interface SimpleFilters {\n  // Note: merchantId removed - tenant databases are already isolated per tenant\n  outletId?: number;\n  isActive?: boolean;\n  search?: string;\n  page?: number;\n  limit?: number;\n}\n\nexport interface SimpleResponse<T> {\n  data: T[];\n  total: number;\n  page: number;\n  limit: number;\n  hasMore: boolean;\n}\n\n// ============================================================================\n// SIMPLIFIED DATABASE API\n// ============================================================================\n\n/**\n * Simplified database operations\n * Replaces the complex dual ID system with simple, consistent operations\n */\nconst db = {\n  // ============================================================================\n  // PRISMA CLIENT (for transactions)\n  // ============================================================================\n  prisma,\n\n  // ============================================================================\n  // USER OPERATIONS\n  // ============================================================================\n  users: simplifiedUsers,\n\n  // ============================================================================\n  // CUSTOMER OPERATIONS\n  // ============================================================================\n  customers: simplifiedCustomers,\n\n  // ============================================================================\n  // PRODUCT OPERATIONS\n  // ============================================================================\n  products: simplifiedProducts,\n\n  // ============================================================================\n  // ORDER OPERATIONS\n  // ============================================================================\n  orders: simplifiedOrders,\n\n  // ============================================================================\n  // PAYMENT OPERATIONS\n  // ============================================================================\n  payments: simplifiedPayments,\n\n  // ============================================================================\n  // OUTLET OPERATIONS\n  // ============================================================================\n  outlets: simplifiedOutlets,\n\n  // ============================================================================\n  // MERCHANT OPERATIONS\n  // ============================================================================\n  // merchants: simplifiedMerchants, // TEMPORARY: Disabled for multi-tenant migration\n\n  // ============================================================================\n  // PLAN OPERATIONS\n  // ============================================================================\n  plans: simplifiedPlans,\n\n  // ============================================================================\n  // CATEGORY OPERATIONS\n  // ============================================================================\n  categories: simplifiedCategories,\n\n  // ============================================================================\n  // AUDIT LOG OPERATIONS\n  // ============================================================================\n  auditLogs: simplifiedAuditLogs,\n\n  // ============================================================================\n  // ORDER ITEM OPERATIONS\n  // ============================================================================\n  orderItems: simplifiedOrderItems,\n\n  // ============================================================================\n  // SUBSCRIPTION OPERATIONS\n  // ============================================================================\n  subscriptions: simplifiedSubscriptions,\n\n  // ============================================================================\n  // ORDER NUMBER OPERATIONS\n  // ============================================================================\n  orderNumbers: simplifiedOrderNumbers,\n\n  // ============================================================================\n  // OUTLET STOCK OPERATIONS\n  // ============================================================================\n  outletStock: {\n    /**\n     * Aggregate outlet stock statistics\n     */\n    aggregate: async (options: any) => {\n      return await prisma.outletStock.aggregate(options);\n    }\n  },\n\n  // ============================================================================\n  // SUBSCRIPTION ACTIVITY OPERATIONS\n  // ============================================================================\n  subscriptionActivities: simplifiedSubscriptionActivities,\n\n  // ============================================================================\n  // SESSION OPERATIONS (Single Session Enforcement)\n  // ============================================================================\n  sessions\n};\n\n// ============================================================================\n// UTILITY FUNCTIONS\n// ============================================================================\n\n/**\n * Check database connection health\n */\nconst checkDatabaseConnection = async () => {\n  try {\n    await prisma.$queryRaw`SELECT 1`;\n    return { status: 'connected' };\n  } catch (error) {\n    return { status: 'disconnected', error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n};\n\n/**\n * Generate next order number (simplified) - Random 8 digits\n */\nconst generateOrderNumber = async (outletId: number): Promise<string> => {\n  const outlet = await prisma.outlet.findUnique({\n    where: { id: outletId },\n    select: { id: true }\n  });\n\n  if (!outlet) {\n    throw new Error(`Outlet with id ${outletId} not found`);\n  }\n\n  // Generate random 8-digit number\n  const generateRandom8Digits = (): string => {\n    return Math.floor(10000000 + Math.random() * 90000000).toString();\n  };\n\n  const maxRetries = 10;\n  for (let i = 0; i < maxRetries; i++) {\n    const randomSequence = generateRandom8Digits();\n    const orderNumber = randomSequence; // Just 8 random digits, no prefix\n    \n    // Check if order number already exists\n    const existingOrder = await prisma.order.findUnique({\n      where: { orderNumber }\n    });\n\n    if (!existingOrder) {\n      return orderNumber;\n    }\n  }\n\n  throw new Error('Failed to generate unique order number after maximum retries');\n};\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport { db, checkDatabaseConnection, generateOrderNumber };\n\n// Export payment functions\nexport { simplifiedPayments } from './payment';\n\n// Export subscription activity functions\nexport { simplifiedSubscriptionActivities } from './subscription-activity';\n\n// Legacy exports for backward compatibility\n// Note: getSubscriptionByMerchantId removed - tenant databases are already isolated per tenant\nexport { createSubscriptionPayment, updateSubscription, getExpiredSubscriptions, getSubscriptionById } from './subscription';\nexport { AuditLogger, getAuditLogger, extractAuditContext } from './audit';\nexport type { AuditContext } from './audit';\nexport { getOutletOrderStats, createOrderNumberWithFormat } from './order-number-generator';\nexport { getDefaultOutlet } from './outlet';\nexport type { OrderNumberFormat } from './order-number-generator';\nexport { searchOrders } from './order'; // Legacy order search function\n\n// Registration functions\n// Note: registerMerchantWithTrial removed - use registerTenantWithTrial instead\nexport { registerUser, registerTenantWithTrial } from './registration';\nexport type { RegistrationInput, RegistrationResult } from './registration';\n\n// Email verification functions\nexport * from './email-verification';\n\n// Multi-tenant functions\nexport { \n  getTenantDb, \n  createTenantDatabase,\n  clearTenantCache,\n  getCachedTenants\n} from './tenant-db';\n\n// Export getMainDb from tenant-db-manager\nexport { getMainDb } from './tenant-db-manager';\n\n// Main DB functions\nexport {\n  getMainDbClient,\n  getTenantBySubdomain,\n  getTenantById,\n  subdomainExists,\n  tenantEmailExists,\n  createTenant,\n  updateTenant,\n  listAllTenants,\n  getPlanById,\n  listActivePlans,\n  getDefaultPlan\n} from './main-db';\n\nexport type { Tenant, Plan } from './main-db';\n\n// Subdomain utilities\nexport {\n  sanitizeSubdomain,\n  validateSubdomain,\n  generateSubdomain,\n  getRootDomain,\n  getProtocol,\n  buildTenantUrl,\n  extractSubdomain,\n  isReservedSubdomain,\n  getReservedSubdomains\n} from './subdomain-utils';\n\n// ============================================================================\n// MIGRATION GUIDE\n// ============================================================================\n/*\nOLD WAY (139 exports):\nimport { \n  findOutletByPublicId, \n  convertOutletPublicIdToDatabaseId,\n  getCustomerByPublicId as getCustomerById,\n  getOutletByPublicId as getOutletById,\n  // ... 135 more exports\n} from '@rentalshop/database';\n\nNEW WAY (3 main exports):\nimport { db, prisma, checkDatabaseConnection } from '@rentalshop/database';\n\n// Usage examples:\nconst user = await db.users.findById(123);\nconst users = await db.users.search({ page: 1, limit: 20 }); // Note: merchantId not needed - tenant isolation\nconst product = await db.products.findByBarcode('123456789');\nconst orders = await db.orders.search({ outletId: 1, status: 'ACTIVE' });\n\nBENEFITS:\n✅ 93% reduction in exports (139 → 10)\n✅ Consistent API across all entities\n✅ No more dual ID complexity\n✅ Better TypeScript support\n✅ Easier to maintain and debug\n✅ Better performance with optimized queries\n*/\n"],"mappings":"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","names":["import_payment","import_subscription_activity","import_subscription","import_order_number_generator","import_outlet","import_order"]}