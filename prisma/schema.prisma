generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                    @id @default(autoincrement())
  email                  String                 @unique
  password               String
  firstName              String
  lastName               String
  phone                  String?
  role                   UserRole               @default(OUTLET_STAFF) // System role (ADMIN, MERCHANT, OUTLET_ADMIN, OUTLET_STAFF)
  customRoleId           Int? // Custom role for merchant (nullable - only for custom roles)
  isActive               Boolean                @default(true)
  emailVerified          Boolean                @default(false)
  emailVerifiedAt        DateTime?
  passwordChangedAt      DateTime? // Track when password was last changed to invalidate old tokens
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  merchantId             Int?
  outletId               Int?
  deletedAt              DateTime?
  customRole             MerchantRole?          @relation(fields: [customRoleId], references: [id], onDelete: SetNull)
  auditLogs              AuditLog[]
  emailVerifications     EmailVerification[]
  createdOrders          Order[]
  passwordResets         PasswordReset[]
  subscriptionActivities SubscriptionActivity[]
  merchant               Merchant?              @relation(fields: [merchantId], references: [id])
  outlet                 Outlet?                @relation(fields: [outletId], references: [id])
  sessions               UserSession[]

  @@unique([merchantId, email])
  @@unique([merchantId, phone])
  @@index([email])
  @@index([merchantId])
  @@index([outletId])
  @@index([deletedAt])
  @@index([emailVerified])
}

model UserSession {
  id            Int       @id @default(autoincrement())
  userId        Int
  sessionId     String    @unique
  ipAddress     String?
  userAgent     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  invalidatedAt DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([sessionId])
  @@index([expiresAt])
}

model Merchant {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  phone         String?
  /// Human friendly tenant key (used for subdomain like aodaipham1.anyrent.shop)
  /// Optional now to avoid breaking existing data, but should be filled for new merchants.
  tenantKey     String?        @unique
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?
  businessType  BusinessType   @default(GENERAL)
  taxId         String?
  website       String?
  description   String?
  planId        Int?
  totalRevenue  Float          @default(0)
  lastActiveAt  DateTime?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  pricingConfig String?        @default("{\"businessType\":\"GENERAL\",\"defaultPricingType\":\"FIXED\",\"businessRules\":{\"requireRentalDates\":false,\"showPricingOptions\":false},\"durationLimits\":{\"minDuration\":1,\"maxDuration\":1,\"defaultDuration\":1}}")
  pricingType   PricingType    @default(FIXED)
  currency      String         @default("USD")
  avatar        String? // Avatar image URL
  categories    Category[]
  customers     Customer[]
  Plan          Plan?          @relation(fields: [planId], references: [id])
  outlets       Outlet[]
  payments      Payment[]
  products      Product[]
  subscription  Subscription?
  users         User[]
  roles         MerchantRole[] // All roles (system role customizations + custom roles)

  @@index([name])
  @@index([email])
  @@index([planId])
}

model Outlet {
  id           Int           @id @default(autoincrement())
  name         String
  address      String?
  description  String?
  isActive     Boolean       @default(true)
  isDefault    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  merchantId   Int
  phone        String?
  city         String?
  country      String?
  state        String?
  zipCode      String?
  avatar       String? // Avatar image URL
  orders       Order[]
  merchant     Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  products     OutletStock[]
  users        User[]
  bankAccounts BankAccount[] // Bank accounts for this outlet

  @@index([merchantId])
  @@index([name])
  @@index([isDefault])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  merchantId  Int
  isDefault   Boolean   @default(false)
  merchant    Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  products    Product[]

  @@unique([merchantId, name])
  @@index([merchantId])
}

model Product {
  id             Int           @id @default(autoincrement())
  name           String
  description    String?
  barcode        String?       @unique
  totalStock     Int           @default(0)
  rentPrice      Float
  salePrice      Float?
  deposit        Float         @default(0)
  images         Json?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  merchantId     Int
  categoryId     Int
  costPrice      Float?
  pricingType    PricingType?
  durationConfig String?
  orderItems     OrderItem[]
  outletStock    OutletStock[]
  category       Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  merchant       Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([categoryId])
  @@index([barcode])
  @@index([name])
  @@index([pricingType])
}

model OutletStock {
  id        Int      @id @default(autoincrement())
  stock     Int      @default(0)
  available Int      @default(0)
  renting   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  productId Int
  outletId  Int
  outlet    Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, outletId])
  @@index([outletId, available])
  @@index([productId])
}

model Customer {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String?   // Optional - allow nullable
  email       String?
  phone       String?   // Optional - allow nullable (unique constraint only applies when phone is not null)
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  dateOfBirth DateTime?
  idNumber    String?
  idType      String?
  notes       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  merchantId  Int
  merchant    Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  orders      Order[]

  // Unique constraint: only applies when phone is not null (PostgreSQL allows multiple NULLs in unique constraint)
  @@unique([merchantId, phone])
  @@index([merchantId, firstName, lastName])
}

model Order {
  id                 Int         @id @default(autoincrement())
  orderNumber        String      @unique
  orderType          OrderType
  status             OrderStatus @default(RESERVED)
  totalAmount        Float
  depositAmount      Float       @default(0)
  securityDeposit    Float       @default(0)
  damageFee          Float       @default(0)
  lateFee            Float       @default(0)
  discountType       String?
  discountValue      Float       @default(0)
  discountAmount     Float       @default(0)
  pickupPlanAt       DateTime?
  returnPlanAt       DateTime?
  pickedUpAt         DateTime?
  returnedAt         DateTime?
  rentalDuration     Int?
  isReadyToDeliver   Boolean     @default(false)
  collateralType     String?
  collateralDetails  String?
  notes              String?
  pickupNotes        String?
  returnNotes        String?
  damageNotes        String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  outletId           Int
  customerId         Int?
  createdById        Int
  rentalDurationUnit String?
  createdBy          User        @relation(fields: [createdById], references: [id])
  customer           Customer?   @relation(fields: [customerId], references: [id])
  outlet             Outlet      @relation(fields: [outletId], references: [id])
  orderItems         OrderItem[]
  payments           Payment[]

  @@index([status, outletId])
  @@index([customerId, createdAt(sort: Desc)])
  @@index([pickupPlanAt, returnPlanAt])
  @@index([orderNumber])
  @@index([isReadyToDeliver, outletId])
  @@index([createdAt])
  @@index([outletId, createdAt])
  @@index([orderType, status])
  @@index([outletId, status, createdAt])
  @@index([createdById, createdAt])
  @@index([totalAmount])
  @@index([status, orderType, createdAt])
}

model OrderItem {
  id             Int     @id @default(autoincrement())
  quantity       Int     @default(1)
  unitPrice      Float
  totalPrice     Float
  deposit        Float   @default(0)
  orderId        Int
  productId      Int
  notes          String?
  rentalDays     Int?
  productName    String?
  productBarcode String?
  productImages  Json?
  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product @relation(fields: [productId], references: [id])

  @@index([orderId, productId])
}

model Payment {
  id             Int           @id @default(autoincrement())
  amount         Float
  currency       String        @default("USD")
  method         PaymentMethod
  type           PaymentType
  status         PaymentStatus @default(PENDING)
  reference      String?
  transactionId  String?
  invoiceNumber  String?
  description    String?
  notes          String?
  failureReason  String?
  metadata       String?
  processedAt    DateTime?
  processedBy    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  orderId        Int?
  subscriptionId Int?
  merchantId     Int?
  merchant       Merchant?     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  order          Order?        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([orderId, status])
  @@index([subscriptionId, status])
  @@index([merchantId, status])
  @@index([status])
  @@index([type])
  @@index([method])
  @@index([currency])
}

model Plan {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  description   String
  basePrice     Float
  currency      String         @default("USD")
  trialDays     Int            @default(14)
  limits        String         @default("{\"outlets\": 0, \"users\": 0, \"products\": 0, \"customers\": 0}")
  features      String         @default("[]")
  isActive      Boolean        @default(true)
  isPopular     Boolean        @default(false)
  sortOrder     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  Merchant      Merchant[]
  subscriptions Subscription[]

  @@index([isActive])
  @@index([sortOrder])
  @@index([deletedAt])
}

model Subscription {
  id                 Int                    @id @default(autoincrement())
  merchantId         Int                    @unique
  planId             Int
  status             String                 @default("trial")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialStart         DateTime?
  trialEnd           DateTime?
  cancelAtPeriodEnd  Boolean                @default(false)
  canceledAt         DateTime?
  cancelReason       String?
  amount             Float
  currency           String                 @default("USD")
  interval           String                 @default("month")
  intervalCount      Int                    @default(1)
  period             Int                    @default(1)
  discount           Float                  @default(0)
  savings            Float                  @default(0)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  payments           Payment[]
  merchant           Merchant               @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  plan               Plan                   @relation(fields: [planId], references: [id])
  activities         SubscriptionActivity[]

  @@index([merchantId])
  @@index([planId])
  @@index([status])
  @@index([currency])
}

model SubscriptionActivity {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  type           String
  description    String
  metadata       String?
  performedBy    Int?
  createdAt      DateTime     @default(now())
  reason         String?
  user           User?        @relation(fields: [performedBy], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([type])
  @@index([createdAt])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  entityType String
  entityId   String
  action     String
  details    String
  userId     Int?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model EmailVerification {
  id         Int       @id @default(autoincrement())
  userId     Int
  token      String    @unique
  email      String
  verified   Boolean   @default(false)
  verifiedAt DateTime?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@index([verified])
}

model PasswordReset {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  email     String
  used      Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@index([used])
}

enum BusinessType {
  GENERAL
  VEHICLE
  CLOTHING
  EQUIPMENT
}

enum PricingType {
  FIXED
  HOURLY
  DAILY
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  PAUSED
  CANCELLED
  EXPIRED
}

enum OrderStatus {
  RESERVED
  PICKUPED
  RETURNED
  COMPLETED
  CANCELLED
}

enum OrderType {
  RENT
  SALE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  STRIPE
  TRANSFER
  MANUAL
  CASH
  CHECK
  PAYPAL
}

enum PaymentType {
  ORDER_PAYMENT
  SUBSCRIPTION_PAYMENT
  PLAN_CHANGE
  PLAN_EXTENSION
}

enum UserRole {
  ADMIN
  MERCHANT
  OUTLET_ADMIN
  OUTLET_STAFF
}

// ============================================================================
// MERCHANT ROLES (Unified Model for System & Custom Roles)
// ============================================================================
// This model allows merchants to:
// 1. Customize permissions for system roles (ADMIN, MERCHANT, OUTLET_ADMIN, OUTLET_STAFF)
// 2. Create custom roles (e.g., WAREHOUSE_MANAGER, SALES_REP, ACCOUNTANT)
// 
// Logic:
// - If isSystemRole = true: roleName must be one of system roles, systemRole must match
// - If isSystemRole = false: roleName is custom role name, systemRole is null
// - If no custom permissions exist, system uses default ROLE_PERMISSIONS
// ============================================================================

model MerchantRole {
  id           Int       @id @default(autoincrement())
  merchantId   Int
  roleName     String // Role name (system role name or custom role name)
  isSystemRole Boolean   @default(false) // true = system role customization, false = custom role
  systemRole   UserRole? // System role enum (only set when isSystemRole = true)
  description  String? // Optional description
  permissions  String[] // Array of permission strings (e.g., ['products.view', 'orders.create'])
  isActive     Boolean   @default(true) // Allow enabling/disabling this role
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  users    User[] // Users assigned to this role

  @@unique([merchantId, roleName]) // One role name per merchant (case-sensitive)
  @@index([merchantId])
  @@index([roleName])
  @@index([merchantId, roleName])
  @@index([merchantId, isSystemRole])
  @@index([systemRole])
}

// ============================================================================
// BANK ACCOUNT (For Vietnam Local Bank Transfer)
// ============================================================================
// Bank accounts for outlets to receive payments via bank transfer
// Supports QR code generation for Vietnam bank transfer (VietQR format)
// Each outlet can have multiple bank accounts

model BankAccount {
  id                Int      @id @default(autoincrement())
  accountHolderName String // Tên chủ tài khoản
  accountNumber     String // Số tài khoản
  bankName          String // Tên ngân hàng (e.g., "Vietcombank", "Techcombank")
  bankCode          String? // Mã ngân hàng (e.g., "VCB", "TCB") - optional but recommended
  branch            String? // Chi nhánh - optional
  isDefault         Boolean  @default(false) // Default account for payments
  qrCode            String? // QR code data (VietQR format or simple format)
  notes             String? // Ghi chú
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  outletId          Int // Belongs to outlet, not merchant
  outlet            Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  @@index([outletId])
  @@index([outletId, isDefault])
  @@index([outletId, isActive])
}
